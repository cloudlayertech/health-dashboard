<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Health Dashboard - Oura + Strava</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0d0d0f;
      --bg-secondary: #1a1a1f;
      --bg-card: #1f1f24;
      --bg-elevated: #2a2a30;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a8;
      --text-muted: #6b6b73;
      --accent-primary: #00d4aa;
      --accent-secondary: #667eea;
      --accent-tertiary: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Loading Skeleton Animation */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .skeleton {
      background: linear-gradient(90deg, var(--bg-elevated) 25%, var(--bg-card) 50%, var(--bg-elevated) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    .skeleton-text {
      height: 1em;
      width: 60%;
      margin: 0.5em 0;
    }

    .skeleton-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
    }

    /* Smooth Transitions */
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-up {
      animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    @media (min-width: 768px) {
      .container { padding: 24px; }
    }

    /* Header */
    header {
      text-align: center;
      padding: 24px 16px 32px;
      position: relative;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    @media (min-width: 768px) {
      header h1 { font-size: 2.25rem; }
    }

    header p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Connection Status */
    .connection-status {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 50px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .status-badge:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .status-badge.connected {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.1);
    }

    .status-badge.disconnected {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-dot.green { background: var(--success); }
    .status-dot.red { background: var(--danger); }

    .connect-btn {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border: none;
      color: var(--bg-primary);
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      margin-left: 8px;
      transition: all 0.2s ease;
    }

    .connect-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
    }

    .connect-btn:active {
      transform: scale(0.98);
    }

    /* Date Selector */
    .date-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      flex-wrap: wrap;
    }

    @media (min-width: 768px) {
      .date-selector { gap: 16px; }
    }

    .date-selector label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.85rem;
      display: none;
    }

    @media (min-width: 768px) {
      .date-selector label { display: block; }
    }

    .date-selector input[type="date"] {
      padding: 10px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      color: var(--text-primary);
      background: var(--bg-elevated);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-selector input[type="date"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.2);
    }

    .date-nav-btn {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .date-nav-btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
      border-color: var(--accent-primary);
      transform: translateY(-1px);
    }

    .date-nav-btn:active {
      transform: translateY(0);
    }

    .today-btn {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: var(--bg-primary);
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .today-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 212, 170, 0.3);
    }

    /* Hero Score Cards - Radial Progress */
    .hero-scores {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (min-width: 768px) {
      .hero-scores {
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }
    }

    .score-ring-card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      position: relative;
      overflow: hidden;
    }

    .score-ring-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .score-ring-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow);
      border-color: var(--accent-primary);
    }

    .score-ring-card:hover::before {
      opacity: 1;
    }

    .score-ring-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin-bottom: 12px;
    }

    @media (min-width: 768px) {
      .score-ring-container {
        width: 120px;
        height: 120px;
      }
    }

    .score-ring-bg {
      fill: none;
      stroke: var(--bg-elevated);
      stroke-width: 8;
    }

    .score-ring-progress {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: center;
      transition: stroke-dashoffset 1s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .score-ring-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .score-ring-value .number {
      font-size: 1.75rem;
      font-weight: 800;
      display: block;
      line-height: 1;
    }

    @media (min-width: 768px) {
      .score-ring-value .number { font-size: 2rem; }
    }

    .score-ring-value .unit {
      font-size: 0.7rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    .score-ring-card .label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .score-ring-card .trend {
      font-size: 0.7rem;
      font-weight: 500;
      padding: 4px 8px;
      border-radius: 20px;
      background: var(--bg-elevated);
    }

    .trend.up { color: var(--success); background: rgba(16, 185, 129, 0.15); }
    .trend.down { color: var(--danger); background: rgba(239, 68, 68, 0.15); }
    .trend.neutral { color: var(--text-muted); }

    /* Weekly Heat Map */
    .weekly-heatmap {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border);
    }

    .heatmap-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .heatmap-header h3 {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .heatmap-legend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .legend-block {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .heatmap-day {
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      position: relative;
    }

    .heatmap-day:hover {
      transform: scale(1.1);
      z-index: 1;
    }

    .heatmap-day .day-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .heatmap-day .day-score {
      font-size: 0.8rem;
      font-weight: 700;
    }

    .heatmap-day.excellent { background: rgba(16, 185, 129, 0.3); color: var(--success); }
    .heatmap-day.good { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    .heatmap-day.fair { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .heatmap-day.poor { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .heatmap-day.empty { background: var(--bg-elevated); color: var(--text-muted); }

    /* Quick Stats Bar */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }

    @media (min-width: 768px) {
      .quick-stats {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .quick-stat {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .quick-stat:hover {
      border-color: var(--accent-secondary);
      transform: translateY(-2px);
    }

    .quick-stat .stat-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 6px;
    }

    .quick-stat .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .quick-stat .stat-unit {
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-secondary);
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (min-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 20px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .card:hover {
      border-color: rgba(255,255,255,0.12);
    }

    .card h2 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .card h2 .icon {
      font-size: 1.1rem;
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 220px;
    }

    @media (min-width: 768px) {
      .chart-container { height: 250px; }
    }

    /* Activity List */
    .activity-list {
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--bg-elevated) transparent;
    }

    .activity-list::-webkit-scrollbar {
      width: 6px;
    }

    .activity-list::-webkit-scrollbar-track {
      background: transparent;
    }

    .activity-list::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-radius: var(--radius-md);
      background: var(--bg-elevated);
      margin-bottom: 8px;
      border: 1px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .activity-item:hover {
      transform: translateX(4px);
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--accent-secondary);
    }

    .activity-item.highlighted {
      background: rgba(0, 212, 170, 0.1);
      border-color: var(--accent-primary);
    }

    .activity-info h3 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .activity-info p {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .activity-stats {
      text-align: right;
    }

    .activity-stats .distance {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent-primary);
    }

    .activity-stats .time {
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    /* Metrics Section */
    .metrics-section {
      margin-bottom: 24px;
    }

    .metrics-section h2 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .metrics-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
    }

    @media (min-width: 1200px) {
      .metrics-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .metric-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 18px;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }

    .metric-card:hover {
      border-color: var(--accent-secondary);
    }

    .metric-card h3 {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .metric-row .label {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .metric-row .value {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.85rem;
    }

    /* Sleep Stages */
    .sleep-stages {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 14px;
    }

    .sleep-stage {
      text-align: center;
      padding: 10px 6px;
      border-radius: var(--radius-sm);
      font-size: 0.65rem;
      font-weight: 600;
    }

    .sleep-stage.deep { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
    .sleep-stage.rem { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
    .sleep-stage.light { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    .sleep-stage.awake { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

    .sleep-stage .stage-value {
      font-size: 1rem;
      font-weight: 700;
      display: block;
      margin-bottom: 2px;
    }

    /* Insights Section */
    .insights-section {
      margin-bottom: 24px;
    }

    .insights-section h2 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .insights-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .insights-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .insight-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 18px;
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent-secondary);
      transition: all 0.3s ease;
    }

    .insight-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .insight-card.positive {
      border-left-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, var(--bg-card) 100%);
    }

    .insight-card.negative {
      border-left-color: var(--danger);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, var(--bg-card) 100%);
    }

    .insight-card.neutral {
      border-left-color: var(--accent-secondary);
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, var(--bg-card) 100%);
    }

    .insight-card h3 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .insight-card p {
      color: var(--text-secondary);
      font-size: 0.8rem;
      line-height: 1.5;
    }

    .insight-card .recommendation {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-weight: 500;
      color: var(--accent-primary);
      font-size: 0.8rem;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--bg-elevated);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Full Width Card */
    .full-width {
      grid-column: 1 / -1;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 16px;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      border: 1px solid var(--border);
      animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--bg-elevated);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.2rem;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: var(--danger);
      color: white;
    }

    .modal-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .modal-header p {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .detail-item {
      background: var(--bg-elevated);
      padding: 14px;
      border-radius: var(--radius-md);
    }

    .detail-item .label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .detail-item .value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .detail-item .value .unit {
      font-size: 0.8rem;
      font-weight: 400;
      color: var(--text-secondary);
    }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Health Dashboard</h1>
      <p>Oura Ring + Strava unified view</p>
    </header>

    <div class="connection-status">
      <div class="status-badge disconnected" id="strava-status">
        <span class="status-dot red"></span>
        <span>Strava</span>
        <button class="connect-btn" id="connect-strava">Connect</button>
      </div>
      <div class="status-badge disconnected" id="oura-status">
        <span class="status-dot red"></span>
        <span>Oura</span>
        <button class="connect-btn" id="connect-oura">Connect</button>
      </div>
    </div>

    <!-- Date Selector -->
    <div class="date-selector">
      <button class="date-nav-btn" id="prev-day">&larr;</button>
      <label>View Date:</label>
      <input type="date" id="selected-date" />
      <button class="today-btn" id="today-btn">Today</button>
      <button class="date-nav-btn" id="next-day">&rarr;</button>
    </div>

    <!-- Hero Score Cards with Radial Progress -->
    <div class="hero-scores" id="hero-scores">
      <div class="score-ring-card">
        <div class="label">Readiness</div>
        <div class="score-ring-container">
          <svg viewBox="0 0 100 100">
            <circle class="score-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="score-ring-progress" id="readiness-ring" cx="50" cy="50" r="42"
                    stroke="url(#gradient-readiness)" stroke-dasharray="264" stroke-dashoffset="264"/>
            <defs>
              <linearGradient id="gradient-readiness" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00d4aa"/>
                <stop offset="100%" style="stop-color:#667eea"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-ring-value">
            <span class="number" id="readiness-score">--</span>
          </div>
        </div>
        <div class="trend neutral" id="readiness-trend">Connect Oura</div>
      </div>

      <div class="score-ring-card">
        <div class="label">Sleep</div>
        <div class="score-ring-container">
          <svg viewBox="0 0 100 100">
            <circle class="score-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="score-ring-progress" id="sleep-ring" cx="50" cy="50" r="42"
                    stroke="url(#gradient-sleep)" stroke-dasharray="264" stroke-dashoffset="264"/>
            <defs>
              <linearGradient id="gradient-sleep" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#667eea"/>
                <stop offset="100%" style="stop-color:#ec4899"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-ring-value">
            <span class="number" id="sleep-score">--</span>
          </div>
        </div>
        <div class="trend neutral" id="sleep-trend">Connect Oura</div>
      </div>

      <div class="score-ring-card">
        <div class="label">HRV</div>
        <div class="score-ring-container">
          <svg viewBox="0 0 100 100">
            <circle class="score-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="score-ring-progress" id="hrv-ring" cx="50" cy="50" r="42"
                    stroke="url(#gradient-hrv)" stroke-dasharray="264" stroke-dashoffset="264"/>
            <defs>
              <linearGradient id="gradient-hrv" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ec4899"/>
                <stop offset="100%" style="stop-color:#f59e0b"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-ring-value">
            <span class="number" id="hrv-value">--</span>
            <span class="unit">ms</span>
          </div>
        </div>
        <div class="trend neutral" id="hrv-trend">Connect Oura</div>
      </div>

      <div class="score-ring-card">
        <div class="label">Resting HR</div>
        <div class="score-ring-container">
          <svg viewBox="0 0 100 100">
            <circle class="score-ring-bg" cx="50" cy="50" r="42"/>
            <circle class="score-ring-progress" id="hr-ring" cx="50" cy="50" r="42"
                    stroke="url(#gradient-hr)" stroke-dasharray="264" stroke-dashoffset="264"/>
            <defs>
              <linearGradient id="gradient-hr" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ef4444"/>
                <stop offset="100%" style="stop-color:#f59e0b"/>
              </linearGradient>
            </defs>
          </svg>
          <div class="score-ring-value">
            <span class="number" id="resting-hr">--</span>
            <span class="unit">bpm</span>
          </div>
        </div>
        <div class="trend neutral" id="hr-trend">Connect Oura</div>
      </div>
    </div>

    <!-- Weekly Heat Map -->
    <div class="weekly-heatmap">
      <div class="heatmap-header">
        <h3>Weekly Overview</h3>
        <div class="heatmap-legend">
          <span>Poor</span>
          <div class="legend-block" style="background: rgba(239, 68, 68, 0.3)"></div>
          <div class="legend-block" style="background: rgba(245, 158, 11, 0.3)"></div>
          <div class="legend-block" style="background: rgba(52, 211, 153, 0.3)"></div>
          <div class="legend-block" style="background: rgba(16, 185, 129, 0.4)"></div>
          <span>Excellent</span>
        </div>
      </div>
      <div class="heatmap-grid" id="heatmap-grid">
        <!-- Will be populated by JS -->
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="quick-stat">
        <div class="stat-label">Weekly Distance</div>
        <div class="stat-value" id="weekly-distance">--<span class="stat-unit"> mi</span></div>
      </div>
      <div class="quick-stat">
        <div class="stat-label">Activities</div>
        <div class="stat-value" id="weekly-activities">--</div>
      </div>
      <div class="quick-stat">
        <div class="stat-label">Avg Sleep</div>
        <div class="stat-value" id="avg-sleep">--<span class="stat-unit"> hrs</span></div>
      </div>
      <div class="quick-stat">
        <div class="stat-label">Steps Today</div>
        <div class="stat-value" id="daily-steps">--</div>
      </div>
    </div>

    <!-- Main Dashboard Charts -->
    <div class="dashboard-grid">
      <!-- Sleep Chart -->
      <div class="card">
        <h2><span class="icon">Sleep Score</span></h2>
        <div class="chart-container">
          <canvas id="sleep-chart"></canvas>
        </div>
      </div>

      <!-- Readiness Chart -->
      <div class="card">
        <h2><span class="icon">Readiness Score</span></h2>
        <div class="chart-container">
          <canvas id="readiness-chart"></canvas>
        </div>
      </div>

      <!-- HRV Chart -->
      <div class="card">
        <h2><span class="icon">HRV Trend</span></h2>
        <div class="chart-container">
          <canvas id="hrv-chart"></canvas>
        </div>
      </div>

      <!-- Activity Chart -->
      <div class="card">
        <h2><span class="icon">Training Load</span></h2>
        <div class="chart-container">
          <canvas id="activity-chart"></canvas>
        </div>
      </div>

      <!-- Recent Activities -->
      <div class="card full-width">
        <h2><span class="icon">Recent Activities</span></h2>
        <div class="activity-list" id="activity-list">
          <div class="loading">
            <div class="loading-spinner"></div>
            <p>Loading activities...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Metrics -->
    <div class="metrics-section">
      <h2>Detailed Metrics</h2>
      <div class="metrics-grid">
        <!-- Sleep Details -->
        <div class="metric-card">
          <h3>Last Night's Sleep</h3>
          <div class="metric-row">
            <span class="label">Total Sleep</span>
            <span class="value" id="total-sleep">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Time in Bed</span>
            <span class="value" id="time-in-bed">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Efficiency</span>
            <span class="value" id="sleep-efficiency">--</span>
          </div>
          <div class="sleep-stages">
            <div class="sleep-stage deep">
              <span class="stage-value" id="deep-sleep">--</span>
              Deep
            </div>
            <div class="sleep-stage rem">
              <span class="stage-value" id="rem-sleep">--</span>
              REM
            </div>
            <div class="sleep-stage light">
              <span class="stage-value" id="light-sleep">--</span>
              Light
            </div>
            <div class="sleep-stage awake">
              <span class="stage-value" id="awake-time">--</span>
              Awake
            </div>
          </div>
        </div>

        <!-- Readiness Contributors -->
        <div class="metric-card">
          <h3>Readiness Contributors</h3>
          <div class="metric-row">
            <span class="label">Previous Night</span>
            <span class="value" id="contrib-sleep">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Sleep Balance</span>
            <span class="value" id="contrib-sleep-balance">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Previous Day Activity</span>
            <span class="value" id="contrib-activity">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Activity Balance</span>
            <span class="value" id="contrib-activity-balance">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Body Temperature</span>
            <span class="value" id="contrib-temp">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Recovery Index</span>
            <span class="value" id="contrib-recovery">--</span>
          </div>
        </div>

        <!-- Activity Summary -->
        <div class="metric-card">
          <h3>Activity Summary</h3>
          <div class="metric-row">
            <span class="label">Active Calories</span>
            <span class="value" id="active-calories">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Total Calories</span>
            <span class="value" id="total-calories">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Low Activity</span>
            <span class="value" id="low-activity">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Medium Activity</span>
            <span class="value" id="medium-activity">--</span>
          </div>
          <div class="metric-row">
            <span class="label">High Activity</span>
            <span class="value" id="high-activity">--</span>
          </div>
        </div>

        <!-- Strava Stats -->
        <div class="metric-card">
          <h3>Training Stats</h3>
          <div class="metric-row">
            <span class="label">This Week Distance</span>
            <span class="value" id="strava-week-distance">--</span>
          </div>
          <div class="metric-row">
            <span class="label">This Week Time</span>
            <span class="value" id="strava-week-time">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Elevation Gain</span>
            <span class="value" id="strava-week-elevation">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Avg Heart Rate</span>
            <span class="value" id="strava-avg-hr">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Longest Activity</span>
            <span class="value" id="strava-longest">--</span>
          </div>
          <div class="metric-row">
            <span class="label">Activity Types</span>
            <span class="value" id="strava-types">--</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Insights Section -->
    <div class="insights-section">
      <h2>Insights & Recommendations</h2>
      <div class="insights-grid" id="insights-grid">
        <div class="insight-card neutral">
          <h3>Loading insights...</h3>
          <p>Connect your data sources to see personalized recommendations.</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Activity Detail Modal -->
  <div class="modal-overlay" id="activity-modal">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">&times;</button>
      <div class="modal-header">
        <h2 id="modal-title">Activity Details</h2>
        <p id="modal-subtitle"></p>
      </div>
      <div class="detail-grid" id="modal-details">
      </div>
    </div>
  </div>

  <script>
    // Global data storage
    let stravaData = { activities: [], athlete: null };
    let ouraData = { sleep: [], readiness: [], activity: [], heartrate: [], sleepDetails: [] };
    let selectedDate = new Date();

    // Chart.js dark theme defaults
    Chart.defaults.color = '#a0a0a8';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.08)';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkStravaConnection();
      checkOuraConnection();

      document.getElementById('connect-strava').addEventListener('click', connectStrava);
      document.getElementById('connect-oura').addEventListener('click', connectOura);

      initDateSelector();
      initModal();
      initHeatmap();

      const params = new URLSearchParams(window.location.search);
      if (params.get('strava') === 'connected') {
        updateStravaStatus(true);
        loadStravaData();
        history.replaceState({}, '', '/');
      }
      if (params.get('oura') === 'connected') {
        updateOuraStatus(true);
        loadOuraData();
        history.replaceState({}, '', '/');
      }
    });

    // Initialize Heatmap with empty state
    function initHeatmap() {
      const grid = document.getElementById('heatmap-grid');
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      grid.innerHTML = days.map(day => `
        <div class="heatmap-day empty">
          <span class="day-label">${day}</span>
          <span class="day-score">--</span>
        </div>
      `).join('');
    }

    // Update Heatmap with data
    function updateHeatmap() {
      const grid = document.getElementById('heatmap-grid');
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const today = new Date();

      // Get last 7 days of readiness data
      const weekData = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = formatDateForInput(date);
        const readiness = ouraData.readiness.find(r => r.day === dateStr);
        weekData.push({
          day: days[date.getDay()],
          score: readiness?.score || null,
          date: dateStr
        });
      }

      grid.innerHTML = weekData.map(d => {
        let className = 'empty';
        if (d.score !== null) {
          if (d.score >= 85) className = 'excellent';
          else if (d.score >= 70) className = 'good';
          else if (d.score >= 50) className = 'fair';
          else className = 'poor';
        }
        return `
          <div class="heatmap-day ${className}" onclick="selectDate('${d.date}')">
            <span class="day-label">${d.day}</span>
            <span class="day-score">${d.score !== null ? d.score : '--'}</span>
          </div>
        `;
      }).join('');
    }

    function selectDate(dateStr) {
      selectedDate = new Date(dateStr + 'T12:00:00');
      document.getElementById('selected-date').value = dateStr;
      updateDisplayForDate();
    }

    // Update Score Ring Animation
    function updateScoreRing(ringId, score, maxScore = 100) {
      const ring = document.getElementById(ringId);
      if (!ring) return;

      const circumference = 2 * Math.PI * 42; // r = 42
      const offset = circumference - (score / maxScore) * circumference;

      // Animate after a small delay for smooth entry
      setTimeout(() => {
        ring.style.strokeDashoffset = offset;
      }, 100);
    }

    // Date Selector Functions
    function initDateSelector() {
      const dateInput = document.getElementById('selected-date');
      const prevBtn = document.getElementById('prev-day');
      const nextBtn = document.getElementById('next-day');
      const todayBtn = document.getElementById('today-btn');

      dateInput.value = formatDateForInput(selectedDate);

      dateInput.addEventListener('change', (e) => {
        selectedDate = new Date(e.target.value + 'T12:00:00');
        updateDisplayForDate();
      });

      prevBtn.addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() - 1);
        dateInput.value = formatDateForInput(selectedDate);
        updateDisplayForDate();
      });

      nextBtn.addEventListener('click', () => {
        selectedDate.setDate(selectedDate.getDate() + 1);
        dateInput.value = formatDateForInput(selectedDate);
        updateDisplayForDate();
      });

      todayBtn.addEventListener('click', () => {
        selectedDate = new Date();
        dateInput.value = formatDateForInput(selectedDate);
        updateDisplayForDate();
      });
    }

    function formatDateForInput(date) {
      return date.toISOString().split('T')[0];
    }

    function updateDisplayForDate() {
      updateOuraSummaryForDate(selectedDate);
      updateStravaForDate(selectedDate);
    }

    function updateOuraSummaryForDate(date) {
      const dateStr = formatDateForInput(date);

      const readiness = ouraData.readiness.find(r => r.day === dateStr);
      const sleep = ouraData.sleep.find(s => s.day === dateStr);
      const sleepDetail = ouraData.sleepDetails.find(s => s.day === dateStr);
      const activity = ouraData.activity.find(a => a.day === dateStr);

      // Update Readiness Ring
      if (readiness) {
        document.getElementById('readiness-score').textContent = readiness.score;
        updateScoreRing('readiness-ring', readiness.score);
        const trendText = dateStr === formatDateForInput(new Date()) ? 'Today' :
          date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.getElementById('readiness-trend').textContent = trendText;
        document.getElementById('readiness-trend').className = 'trend neutral';
      } else {
        document.getElementById('readiness-score').textContent = '--';
        updateScoreRing('readiness-ring', 0);
        document.getElementById('readiness-trend').textContent = 'No data';
      }

      // Update Sleep Ring
      if (sleep) {
        document.getElementById('sleep-score').textContent = sleep.score;
        updateScoreRing('sleep-ring', sleep.score);
        const trendText = dateStr === formatDateForInput(new Date()) ? 'Today' :
          date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        document.getElementById('sleep-trend').textContent = trendText;
        document.getElementById('sleep-trend').className = 'trend neutral';
      } else {
        document.getElementById('sleep-score').textContent = '--';
        updateScoreRing('sleep-ring', 0);
        document.getElementById('sleep-trend').textContent = 'No data';
      }

      // Update HRV and HR Rings
      if (sleepDetail) {
        if (sleepDetail.average_hrv) {
          document.getElementById('hrv-value').textContent = sleepDetail.average_hrv;
          // HRV typically ranges 20-80, normalize to 100
          updateScoreRing('hrv-ring', Math.min(sleepDetail.average_hrv, 100));
          document.getElementById('hrv-trend').textContent = dateStr === formatDateForInput(new Date()) ? 'Today' :
            date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        if (sleepDetail.lowest_heart_rate) {
          document.getElementById('resting-hr').textContent = sleepDetail.lowest_heart_rate;
          // Lower HR is better, invert for display (40-80 range)
          const hrScore = Math.max(0, 100 - ((sleepDetail.lowest_heart_rate - 40) * 2.5));
          updateScoreRing('hr-ring', hrScore);
          document.getElementById('hr-trend').textContent = dateStr === formatDateForInput(new Date()) ? 'Today' :
            date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        // Update sleep details
        if (sleepDetail.total_sleep_duration) {
          document.getElementById('total-sleep').textContent = formatDuration(sleepDetail.total_sleep_duration);
        }
        if (sleepDetail.time_in_bed) {
          document.getElementById('time-in-bed').textContent = formatDuration(sleepDetail.time_in_bed);
        }
        if (sleepDetail.efficiency) {
          document.getElementById('sleep-efficiency').textContent = sleepDetail.efficiency + '%';
        }
        if (sleepDetail.deep_sleep_duration) {
          document.getElementById('deep-sleep').textContent = formatDurationShort(sleepDetail.deep_sleep_duration);
        }
        if (sleepDetail.rem_sleep_duration) {
          document.getElementById('rem-sleep').textContent = formatDurationShort(sleepDetail.rem_sleep_duration);
        }
        if (sleepDetail.light_sleep_duration) {
          document.getElementById('light-sleep').textContent = formatDurationShort(sleepDetail.light_sleep_duration);
        }
        if (sleepDetail.awake_time) {
          document.getElementById('awake-time').textContent = formatDurationShort(sleepDetail.awake_time);
        }
      } else {
        document.getElementById('hrv-value').textContent = '--';
        document.getElementById('resting-hr').textContent = '--';
        updateScoreRing('hrv-ring', 0);
        updateScoreRing('hr-ring', 0);
      }

      // Update activity summary
      if (activity) {
        if (activity.steps !== undefined) document.getElementById('daily-steps').textContent = activity.steps.toLocaleString();
        if (activity.active_calories !== undefined) document.getElementById('active-calories').textContent = activity.active_calories + ' kcal';
        if (activity.total_calories !== undefined) document.getElementById('total-calories').textContent = activity.total_calories + ' kcal';
      }
    }

    function updateStravaForDate(date) {
      const dateStr = formatDateForInput(date);
      renderActivitiesWithHighlight(dateStr);
    }

    // Modal Functions
    function initModal() {
      const modal = document.getElementById('activity-modal');
      const closeBtn = document.getElementById('modal-close');

      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }

    function showActivityDetail(activity) {
      const modal = document.getElementById('activity-modal');
      const title = document.getElementById('modal-title');
      const subtitle = document.getElementById('modal-subtitle');
      const details = document.getElementById('modal-details');

      const date = new Date(activity.start_date_local).toLocaleDateString('en-US', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });

      title.textContent = activity.name;
      subtitle.textContent = `${activity.type} â€¢ ${date}`;

      const distanceMi = (activity.distance / 1000 * 0.621371).toFixed(2);
      const elevationFt = activity.total_elevation_gain ? Math.round(activity.total_elevation_gain * 3.28084) : null;
      const avgSpeedMph = activity.average_speed ? (activity.average_speed * 2.237).toFixed(1) : null;
      const maxSpeedMph = activity.max_speed ? (activity.max_speed * 2.237).toFixed(1) : null;
      const pace = activity.distance > 0 ? ((activity.moving_time / 60) / (activity.distance / 1000 * 0.621371)).toFixed(2) : null;

      let detailsHTML = `
        <div class="detail-item">
          <div class="label">Distance</div>
          <div class="value">${distanceMi} <span class="unit">mi</span></div>
        </div>
        <div class="detail-item">
          <div class="label">Duration</div>
          <div class="value">${formatDuration(activity.moving_time)}</div>
        </div>
      `;

      if (activity.type === 'Run' || activity.type === 'Walk' || activity.type === 'Hike') {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Avg Pace</div>
            <div class="value">${pace} <span class="unit">min/mi</span></div>
          </div>
        `;
      }

      if (avgSpeedMph) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Avg Speed</div>
            <div class="value">${avgSpeedMph} <span class="unit">mph</span></div>
          </div>
        `;
      }

      if (maxSpeedMph) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Max Speed</div>
            <div class="value">${maxSpeedMph} <span class="unit">mph</span></div>
          </div>
        `;
      }

      if (elevationFt) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Elevation Gain</div>
            <div class="value">${elevationFt.toLocaleString()} <span class="unit">ft</span></div>
          </div>
        `;
      }

      if (activity.average_heartrate) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Avg Heart Rate</div>
            <div class="value">${Math.round(activity.average_heartrate)} <span class="unit">bpm</span></div>
          </div>
        `;
      }

      if (activity.max_heartrate) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Max Heart Rate</div>
            <div class="value">${Math.round(activity.max_heartrate)} <span class="unit">bpm</span></div>
          </div>
        `;
      }

      if (activity.average_watts) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Avg Power</div>
            <div class="value">${Math.round(activity.average_watts)} <span class="unit">W</span></div>
          </div>
        `;
      }

      if (activity.kilojoules) {
        detailsHTML += `
          <div class="detail-item">
            <div class="label">Energy</div>
            <div class="value">${Math.round(activity.kilojoules)} <span class="unit">kJ</span></div>
          </div>
        `;
      }

      details.innerHTML = detailsHTML;
      modal.classList.add('active');
    }

    function renderActivitiesWithHighlight(highlightDate) {
      const list = document.getElementById('activity-list');

      if (!stravaData.activities || !stravaData.activities.length) {
        list.innerHTML = '<div class="empty-state"><div class="icon">ðŸƒ</div><p>No recent activities</p></div>';
        return;
      }

      const sorted = [...stravaData.activities].sort((a, b) => {
        const aDate = a.start_date_local.split('T')[0];
        const bDate = b.start_date_local.split('T')[0];
        if (aDate === highlightDate && bDate !== highlightDate) return -1;
        if (bDate === highlightDate && aDate !== highlightDate) return 1;
        return new Date(b.start_date_local) - new Date(a.start_date_local);
      });

      list.innerHTML = sorted.slice(0, 15).map((activity) => {
        const actDate = activity.start_date_local.split('T')[0];
        const isHighlighted = actDate === highlightDate;
        const date = new Date(activity.start_date_local).toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric'
        });
        const distanceKm = activity.distance / 1000;
        const distanceMi = distanceKm * 0.621371;
        const duration = Math.floor(activity.moving_time / 60);
        const type = activity.type;

        const pace = distanceMi > 0 ? ((activity.moving_time / 60) / distanceMi).toFixed(1) : '--';
        const avgHR = activity.average_heartrate ? Math.round(activity.average_heartrate) : null;
        const maxHR = activity.max_heartrate ? Math.round(activity.max_heartrate) : null;

        let statsLine = '';
        if (type === 'Run' || type === 'Walk' || type === 'Hike') {
          statsLine = `${pace} min/mi`;
        } else if (type === 'Ride' || type === 'VirtualRide') {
          const avgSpeedMph = activity.average_speed ? (activity.average_speed * 2.237).toFixed(1) : null;
          if (avgSpeedMph) statsLine = `${avgSpeedMph} mph`;
        }

        let hrLine = '';
        if (avgHR && maxHR) {
          hrLine = ` â€¢ ${avgHR}/${maxHR} bpm`;
        }

        return `
          <div class="activity-item ${isHighlighted ? 'highlighted' : ''}" onclick="showActivityDetail(stravaData.activities.find(a => a.id === ${activity.id}))">
            <div class="activity-info">
              <h3>${activity.name}</h3>
              <p>${type} â€¢ ${date}${hrLine}</p>
            </div>
            <div class="activity-stats">
              <div class="distance">${distanceMi.toFixed(1)} mi</div>
              <div class="time">${duration} min${statsLine ? ' â€¢ ' + statsLine : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Connection Functions
    async function connectStrava() {
      const response = await fetch('/api/strava/auth-url');
      const data = await response.json();
      window.location.href = data.url;
    }

    async function connectOura() {
      const response = await fetch('/api/oura/auth-url');
      const data = await response.json();
      window.location.href = data.url;
    }

    async function checkStravaConnection() {
      try {
        const response = await fetch('/api/strava/status');
        const data = await response.json();
        if (data.connected) {
          updateStravaStatus(true);
          loadStravaData();
        }
      } catch (error) {
        console.error('Error checking Strava status:', error);
      }
    }

    async function checkOuraConnection() {
      try {
        const response = await fetch('/api/oura/status');
        const data = await response.json();
        if (data.connected) {
          updateOuraStatus(true);
          loadOuraData();
        }
      } catch (error) {
        console.error('Error checking Oura status:', error);
      }
    }

    function updateStravaStatus(connected) {
      const badge = document.getElementById('strava-status');
      if (connected) {
        badge.classList.remove('disconnected');
        badge.classList.add('connected');
        badge.innerHTML = '<span class="status-dot green"></span><span>Strava</span>';
      }
    }

    function updateOuraStatus(connected) {
      const badge = document.getElementById('oura-status');
      if (connected) {
        badge.classList.remove('disconnected');
        badge.classList.add('connected');
        badge.innerHTML = '<span class="status-dot green"></span><span>Oura</span>';
      } else {
        badge.classList.remove('connected');
        badge.classList.add('disconnected');
        badge.innerHTML = '<span class="status-dot red"></span><span>Oura</span><button class="connect-btn" onclick="connectOura()">Reconnect</button>';
      }
    }

    // Data Loading
    async function loadStravaData() {
      try {
        const [activitiesRes, athleteRes] = await Promise.all([
          fetch('/api/strava/activities'),
          fetch('/api/strava/athlete')
        ]);

        if (activitiesRes.status === 401) {
          const data = await activitiesRes.json();
          if (data.needsAuth) {
            console.log('Strava needs re-authorization');
            return;
          }
        }

        if (activitiesRes.ok) {
          stravaData.activities = await activitiesRes.json();
        }
        if (athleteRes.ok) {
          stravaData.athlete = await athleteRes.json();
        }

        updateStravaStatus(true);
        renderActivities();
        renderActivityChart();
        updateStravaSummary();
        updateStravaDetails();
        generateInsights();
      } catch (error) {
        console.error('Error loading Strava data:', error);
      }
    }

    async function loadOuraData() {
      try {
        const [sleepRes, readinessRes, activityRes, sleepDetailsRes] = await Promise.all([
          fetch('/api/oura/sleep'),
          fetch('/api/oura/readiness'),
          fetch('/api/oura/activity'),
          fetch('/api/oura/sleep-details')
        ]);

        if (sleepRes.status === 401 || readinessRes.status === 401) {
          console.log('Oura token expired, need to reconnect');
          updateOuraStatus(false);
          return;
        }

        if (sleepRes.ok) ouraData.sleep = (await sleepRes.json()).data || [];
        if (readinessRes.ok) ouraData.readiness = (await readinessRes.json()).data || [];
        if (activityRes.ok) ouraData.activity = (await activityRes.json()).data || [];
        if (sleepDetailsRes.ok) ouraData.sleepDetails = (await sleepDetailsRes.json()).data || [];

        if (!ouraData.sleep.length && !ouraData.readiness.length) {
          console.log('No Oura data received');
          updateOuraStatus(false);
          return;
        }

        updateOuraStatus(true);
        renderSleepChart();
        renderReadinessChart();
        renderHRVChart();
        updateOuraSummary();
        updateOuraDetails();
        updateHeatmap();
        updateAvgSleep();
        generateInsights();
      } catch (error) {
        console.error('Error loading Oura data:', error);
        updateOuraStatus(false);
      }
    }

    function updateAvgSleep() {
      if (ouraData.sleepDetails && ouraData.sleepDetails.length >= 7) {
        const recent = ouraData.sleepDetails.slice(-7);
        const avgSeconds = recent.reduce((sum, d) => sum + (d.total_sleep_duration || 0), 0) / recent.length;
        const hours = (avgSeconds / 3600).toFixed(1);
        document.getElementById('avg-sleep').innerHTML = hours + '<span class="stat-unit"> hrs</span>';
      }
    }

    // Update Oura Summary Cards
    function updateOuraSummary() {
      if (ouraData.readiness.length) {
        const latest = ouraData.readiness[ouraData.readiness.length - 1];
        const score = latest.score;
        document.getElementById('readiness-score').textContent = score;
        updateScoreRing('readiness-ring', score);

        if (ouraData.readiness.length > 1) {
          const prev = ouraData.readiness[ouraData.readiness.length - 2].score;
          const diff = score - prev;
          const trendEl = document.getElementById('readiness-trend');
          trendEl.textContent = diff > 0 ? `+${diff} from yesterday` : diff < 0 ? `${diff} from yesterday` : 'Same as yesterday';
          trendEl.className = 'trend ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral');
        }
      }

      if (ouraData.sleep.length) {
        const latest = ouraData.sleep[ouraData.sleep.length - 1];
        const score = latest.score;
        document.getElementById('sleep-score').textContent = score;
        updateScoreRing('sleep-ring', score);

        if (ouraData.sleep.length > 1) {
          const prev = ouraData.sleep[ouraData.sleep.length - 2].score;
          const diff = score - prev;
          const trendEl = document.getElementById('sleep-trend');
          trendEl.textContent = diff > 0 ? `+${diff} from yesterday` : diff < 0 ? `${diff} from yesterday` : 'Same as yesterday';
          trendEl.className = 'trend ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral');
        }
      }

      if (ouraData.sleepDetails && ouraData.sleepDetails.length) {
        const latest = ouraData.sleepDetails[ouraData.sleepDetails.length - 1];
        if (latest.lowest_heart_rate) {
          document.getElementById('resting-hr').textContent = latest.lowest_heart_rate;
          const hrScore = Math.max(0, 100 - ((latest.lowest_heart_rate - 40) * 2.5));
          updateScoreRing('hr-ring', hrScore);
        }
        if (latest.average_hrv) {
          document.getElementById('hrv-value').textContent = latest.average_hrv;
          updateScoreRing('hrv-ring', Math.min(latest.average_hrv, 100));

          if (ouraData.sleepDetails.length > 1) {
            const prev = ouraData.sleepDetails[ouraData.sleepDetails.length - 2];
            if (prev.average_hrv) {
              const diff = latest.average_hrv - prev.average_hrv;
              const trendEl = document.getElementById('hrv-trend');
              trendEl.textContent = diff > 0 ? `+${diff}ms` : diff < 0 ? `${diff}ms` : 'Same';
              trendEl.className = 'trend ' + (diff > 0 ? 'up' : diff < 0 ? 'down' : 'neutral');
            }
          }
        }
      }
    }

    function updateStravaSummary() {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weeklyActivities = stravaData.activities.filter(a =>
        new Date(a.start_date_local) >= weekAgo
      );

      const totalDistanceKm = weeklyActivities.reduce((sum, a) => sum + a.distance, 0) / 1000;
      const totalDistance = totalDistanceKm * 0.621371;
      document.getElementById('weekly-distance').innerHTML = totalDistance.toFixed(1) + '<span class="stat-unit"> mi</span>';
      document.getElementById('weekly-activities').textContent = weeklyActivities.length;
    }

    function updateOuraDetails() {
      if (ouraData.sleepDetails && ouraData.sleepDetails.length) {
        const latest = ouraData.sleepDetails[ouraData.sleepDetails.length - 1];

        if (latest.total_sleep_duration) document.getElementById('total-sleep').textContent = formatDuration(latest.total_sleep_duration);
        if (latest.time_in_bed) document.getElementById('time-in-bed').textContent = formatDuration(latest.time_in_bed);
        if (latest.efficiency) document.getElementById('sleep-efficiency').textContent = latest.efficiency + '%';
        if (latest.deep_sleep_duration) document.getElementById('deep-sleep').textContent = formatDurationShort(latest.deep_sleep_duration);
        if (latest.rem_sleep_duration) document.getElementById('rem-sleep').textContent = formatDurationShort(latest.rem_sleep_duration);
        if (latest.light_sleep_duration) document.getElementById('light-sleep').textContent = formatDurationShort(latest.light_sleep_duration);
        if (latest.awake_time) document.getElementById('awake-time').textContent = formatDurationShort(latest.awake_time);
      }

      if (ouraData.readiness.length) {
        const latest = ouraData.readiness[ouraData.readiness.length - 1];
        const c = latest.contributors || {};

        if (c.previous_night !== undefined) document.getElementById('contrib-sleep').textContent = c.previous_night;
        if (c.sleep_balance !== undefined) document.getElementById('contrib-sleep-balance').textContent = c.sleep_balance;
        if (c.previous_day_activity !== undefined) document.getElementById('contrib-activity').textContent = c.previous_day_activity;
        if (c.activity_balance !== undefined) document.getElementById('contrib-activity-balance').textContent = c.activity_balance;
        if (c.body_temperature !== undefined) document.getElementById('contrib-temp').textContent = c.body_temperature;
        if (c.recovery_index !== undefined) document.getElementById('contrib-recovery').textContent = c.recovery_index;
      }

      if (ouraData.activity.length) {
        const latest = ouraData.activity[ouraData.activity.length - 1];

        if (latest.steps !== undefined) document.getElementById('daily-steps').textContent = latest.steps.toLocaleString();
        if (latest.active_calories !== undefined) document.getElementById('active-calories').textContent = latest.active_calories + ' kcal';
        if (latest.total_calories !== undefined) document.getElementById('total-calories').textContent = latest.total_calories + ' kcal';
        if (latest.low_activity_time !== undefined) document.getElementById('low-activity').textContent = formatDurationShort(latest.low_activity_time);
        if (latest.medium_activity_time !== undefined) document.getElementById('medium-activity').textContent = formatDurationShort(latest.medium_activity_time);
        if (latest.high_activity_time !== undefined) document.getElementById('high-activity').textContent = formatDurationShort(latest.high_activity_time);
      }
    }

    function updateStravaDetails() {
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const weeklyActivities = stravaData.activities.filter(a =>
        new Date(a.start_date_local) >= weekAgo
      );

      const totalDistanceKm = weeklyActivities.reduce((sum, a) => sum + a.distance, 0) / 1000;
      const totalDistance = totalDistanceKm * 0.621371;
      const totalTime = weeklyActivities.reduce((sum, a) => sum + a.moving_time, 0);
      const totalElevationM = weeklyActivities.reduce((sum, a) => sum + (a.total_elevation_gain || 0), 0);
      const totalElevation = totalElevationM * 3.28084;

      document.getElementById('strava-week-distance').textContent = totalDistance.toFixed(1) + ' mi';
      document.getElementById('strava-week-time').textContent = formatDuration(totalTime);
      document.getElementById('strava-week-elevation').textContent = Math.round(totalElevation).toLocaleString() + ' ft';

      const activitiesWithHR = weeklyActivities.filter(a => a.average_heartrate);
      if (activitiesWithHR.length) {
        const avgHR = activitiesWithHR.reduce((sum, a) => sum + a.average_heartrate, 0) / activitiesWithHR.length;
        document.getElementById('strava-avg-hr').textContent = Math.round(avgHR) + ' bpm';
      }

      if (weeklyActivities.length) {
        const longest = weeklyActivities.reduce((max, a) => a.distance > max.distance ? a : max);
        const longestMiles = (longest.distance / 1000) * 0.621371;
        document.getElementById('strava-longest').textContent = longestMiles.toFixed(1) + ' mi';
      }

      const types = [...new Set(weeklyActivities.map(a => a.type))];
      document.getElementById('strava-types').textContent = types.join(', ') || '--';
    }

    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }

    function formatDurationShort(seconds) {
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      if (hours > 0) return `${hours}h${mins > 0 ? mins + 'm' : ''}`;
      return `${mins}m`;
    }

    function renderActivities() {
      renderActivitiesWithHighlight(formatDateForInput(selectedDate));
    }

    // Charts with dark theme and animations
    function renderSleepChart() {
      const ctx = document.getElementById('sleep-chart').getContext('2d');
      const data = ouraData.sleep.slice(-14);

      if (window.sleepChart) window.sleepChart.destroy();

      window.sleepChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(d => {
            const date = new Date(d.day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }),
          datasets: [{
            label: 'Sleep Score',
            data: data.map(d => d.score),
            backgroundColor: data.map(d => {
              if (d.score >= 85) return 'rgba(16, 185, 129, 0.8)';
              if (d.score >= 70) return 'rgba(52, 211, 153, 0.7)';
              if (d.score >= 50) return 'rgba(245, 158, 11, 0.7)';
              return 'rgba(239, 68, 68, 0.7)';
            }),
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 1000, easing: 'easeOutQuart' },
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function renderReadinessChart() {
      const ctx = document.getElementById('readiness-chart').getContext('2d');
      const data = ouraData.readiness.slice(-14);

      if (window.readinessChart) window.readinessChart.destroy();

      const gradient = ctx.createLinearGradient(0, 0, 0, 250);
      gradient.addColorStop(0, 'rgba(0, 212, 170, 0.3)');
      gradient.addColorStop(1, 'rgba(0, 212, 170, 0)');

      window.readinessChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => {
            const date = new Date(d.day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }),
          datasets: [{
            label: 'Readiness',
            data: data.map(d => d.score),
            borderColor: '#00d4aa',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#00d4aa',
            pointBorderColor: '#0d0d0f',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 1000, easing: 'easeOutQuart' },
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function renderHRVChart() {
      const ctx = document.getElementById('hrv-chart').getContext('2d');
      let data = ouraData.sleepDetails ? ouraData.sleepDetails.slice(-14) : [];

      if (window.hrvChart) window.hrvChart.destroy();

      data = data.filter(d => d.average_hrv !== undefined && d.average_hrv !== null);
      if (!data.length) return;

      const gradient = ctx.createLinearGradient(0, 0, 0, 250);
      gradient.addColorStop(0, 'rgba(236, 72, 153, 0.3)');
      gradient.addColorStop(1, 'rgba(236, 72, 153, 0)');

      window.hrvChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => {
            const date = new Date(d.day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }),
          datasets: [{
            label: 'HRV (ms)',
            data: data.map(d => d.average_hrv),
            borderColor: '#ec4899',
            backgroundColor: gradient,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#ec4899',
            pointBorderColor: '#0d0d0f',
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 1000, easing: 'easeOutQuart' },
          plugins: { legend: { display: false } },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function renderActivityChart() {
      const ctx = document.getElementById('activity-chart').getContext('2d');

      if (!stravaData.activities || !stravaData.activities.length) return;

      const weeks = {};
      stravaData.activities.forEach(a => {
        const date = new Date(a.start_date_local);
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - date.getDay());
        const key = weekStart.toISOString().split('T')[0];

        if (!weeks[key]) {
          weeks[key] = { distance: 0, duration: 0, count: 0 };
        }
        weeks[key].distance += (a.distance / 1000) * 0.621371;
        weeks[key].duration += a.moving_time / 3600;
        weeks[key].count++;
      });

      const sortedWeeks = Object.entries(weeks)
        .sort(([a], [b]) => new Date(a) - new Date(b))
        .slice(-8);

      if (window.activityChart) window.activityChart.destroy();

      window.activityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedWeeks.map(([date]) => {
            const d = new Date(date);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }),
          datasets: [{
            label: 'Distance (mi)',
            data: sortedWeeks.map(([, data]) => data.distance.toFixed(1)),
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderRadius: 6
          }, {
            label: 'Duration (hrs)',
            data: sortedWeeks.map(([, data]) => data.duration.toFixed(1)),
            backgroundColor: 'rgba(16, 185, 129, 0.8)',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 1000, easing: 'easeOutQuart' },
          plugins: {
            legend: {
              labels: {
                color: '#a0a0a8',
                usePointStyle: true,
                padding: 20
              }
            }
          },
          scales: {
            y: { grid: { color: 'rgba(255,255,255,0.05)' } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Generate Insights
    function generateInsights() {
      const insights = [];

      if (ouraData.sleep.length >= 7) {
        const recentSleep = ouraData.sleep.slice(-7);
        const avgScore = recentSleep.reduce((sum, d) => sum + d.score, 0) / recentSleep.length;
        const lowSleepDays = recentSleep.filter(d => d.score < 70).length;

        if (avgScore >= 80) {
          insights.push({
            type: 'positive',
            title: 'Excellent Sleep Quality',
            text: `Your average sleep score this week is ${avgScore.toFixed(0)}. Great job maintaining healthy sleep habits!`,
            recommendation: 'Keep up your consistent sleep schedule.'
          });
        } else if (lowSleepDays >= 3) {
          insights.push({
            type: 'negative',
            title: 'Sleep Needs Attention',
            text: `You had ${lowSleepDays} days with sleep scores below 70 this week.`,
            recommendation: 'Try going to bed 30 minutes earlier.'
          });
        }
      }

      if (ouraData.readiness.length) {
        const latest = ouraData.readiness[ouraData.readiness.length - 1];
        if (latest.score >= 85) {
          insights.push({
            type: 'positive',
            title: 'Peak Performance Day',
            text: `Readiness score of ${latest.score} indicates excellent recovery.`,
            recommendation: 'Ideal day for a hard workout!'
          });
        } else if (latest.score < 60) {
          insights.push({
            type: 'negative',
            title: 'Recovery Day Advised',
            text: `Readiness score of ${latest.score} suggests your body needs rest.`,
            recommendation: 'Opt for light activity today.'
          });
        }
      }

      if (stravaData.activities && stravaData.activities.length >= 7) {
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const thisWeek = stravaData.activities.filter(a => new Date(a.start_date_local) >= weekAgo);

        if (thisWeek.length >= 4) {
          insights.push({
            type: 'positive',
            title: 'Strong Training Consistency',
            text: `You completed ${thisWeek.length} workouts this week.`,
            recommendation: 'Balance this with adequate recovery.'
          });
        }
      }

      if (insights.length === 0) {
        insights.push({
          type: 'neutral',
          title: 'Connect Your Data',
          text: 'Connect both Oura and Strava to see personalized insights.',
          recommendation: 'The more data available, the better the recommendations!'
        });
      }

      renderInsights(insights);
    }

    function renderInsights(insights) {
      const grid = document.getElementById('insights-grid');
      grid.innerHTML = insights.map(insight => `
        <div class="insight-card ${insight.type}">
          <h3>${insight.title}</h3>
          <p>${insight.text}</p>
          <div class="recommendation">${insight.recommendation}</div>
        </div>
      `).join('');
    }

  </script>
</body>
</html>
